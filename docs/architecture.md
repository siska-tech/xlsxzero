# **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ (Architecture Design)**

## **ç›®çš„**

æœ¬è¨­è¨ˆæ›¸ã¯ã€[requirements.md](requirements.md)ã§å®šç¾©ã•ã‚ŒãŸè¦ä»¶ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã€xlsxzeroã‚¯ãƒ¬ãƒ¼ãƒˆå…¨ä½“ã®æ§‹é€ çš„ãªéª¨æ ¼ã‚’å®šç¾©ã™ã‚‹ã€‚ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã‚’æ˜ç¢ºã«ã™ã‚‹:

* ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã¨å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è²¬å‹™
* ä¸»è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®å½¹å‰²åˆ†æ‹…ã¨ä¾å­˜é–¢ä¿‚
* æ¡ç”¨ã™ã‚‹è¨­è¨ˆåŸå‰‡ã‚„ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
* æŠ€è¡“é¸å®šã¨ãã®ç†ç”±

æœ¬ã‚¯ãƒ¬ãƒ¼ãƒˆã®ä¸­æ ¸çš„ãªç›®çš„ã¯ã€**RAGã‚·ã‚¹ãƒ†ãƒ ã¸ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æä¾›ã®ãŸã‚ã€Pure-Rustå®Ÿè£…ã«ã‚ˆã‚ŠExcelãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ§‹é€ åŒ–ã•ã‚ŒãŸMarkdownå½¢å¼ã«å¤‰æ›ã™ã‚‹ã“ã¨**ã§ã‚ã‚‹ã€‚

---

## **1. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå›³ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          xlsxzero crate                              â”‚
â”‚                     (å…¬é–‹API / Facade Layer)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Builder     â”‚   â”‚  Converter   â”‚   â”‚   ErrorTypes    â”‚
â”‚   Module      â”‚   â”‚   Module     â”‚   â”‚    Module       â”‚
â”‚ (builder.rs)  â”‚   â”‚(converter.rs)â”‚   â”‚   (error.rs)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚
        â”‚                  â–¼
        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Parser       â”‚
                   â”‚  Module       â”‚
                   â”‚ (parser.rs)   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Formatter   â”‚   â”‚   Grid       â”‚   â”‚   Types         â”‚
â”‚   Module     â”‚   â”‚  Module      â”‚   â”‚   Module        â”‚
â”‚(formatter.rs)â”‚   â”‚  (grid.rs)   â”‚   â”‚  (types.rs)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Number Format Parser    â”‚
â”‚  Submodule               â”‚
â”‚  (format/mod.rs)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

External Dependencies:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  calamine (Pure-Rust Excel parser)                           â”‚
â”‚  thiserror (Error handling)                                  â”‚
â”‚  chrono (Date/Time handling, NaiveDateTime only)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è²¬å‹™**

#### **1.1. Builder Module (`builder.rs`)**
**è²¬å‹™:**
* Fluent Builder APIã®æä¾›
* å¤‰æ›è¨­å®šã®æ®µéšçš„ãªæ§‹ç¯‰ã¨æ¤œè¨¼
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè¨­å®šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æä¾›

**ä¸»è¦ãªæ§‹é€ ä½“:**
* `ConverterBuilder`: è¨­å®šæ§‹ç¯‰ç”¨ã®ãƒ“ãƒ«ãƒ€ãƒ¼æ§‹é€ ä½“
* `ConversionConfig`: å†…éƒ¨è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹æ§‹é€ ä½“

**æä¾›ã™ã‚‹è¨­å®š:**
* ã‚·ãƒ¼ãƒˆé¸æŠï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€åå‰ã€ã™ã¹ã¦ï¼‰
* ã‚»ãƒ«ç¯„å›²æŒ‡å®š
* ã‚»ãƒ«çµåˆæˆ¦ç•¥ï¼ˆãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒ•ã‚£ãƒ« / HTMLãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
* æ—¥ä»˜å½¢å¼ï¼ˆISO 8601ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ / ã‚«ã‚¹ã‚¿ãƒ ï¼‰
* éè¡¨ç¤ºè¦ç´ ã®åŒ…å«åˆ¶å¾¡
* æ•°å¼å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰

#### **1.2. Converter Module (`converter.rs`)**
**è²¬å‹™:**
* å…¬é–‹APIã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
* Parserã€Gridã€Formatterã®å”èª¿åˆ¶å¾¡
* ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ä¸»è¦ãªæ§‹é€ ä½“:**
* `Converter`: å¤‰æ›å‡¦ç†ã®ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰
* å®Ÿè£…ã™ã‚‹ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:
  * `convert<R: Read, W: Write>(&self, input: R, output: W) -> Result<(), XlsxToMdError>`

#### **1.3. Parser Module (`parser.rs`)**
**è²¬å‹™:**
* calamineã‚’ä½¿ç”¨ã—ãŸExcelãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æ
* ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ–¹å¼ã«ã‚ˆã‚‹ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
* ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚·ãƒ¼ãƒˆæƒ…å ±ã€ã‚»ãƒ«çµåˆç¯„å›²ã€æ›¸å¼æƒ…å ±ï¼‰ã®åé›†

**ä¸»è¦ãªæ§‹é€ ä½“:**
* `WorkbookParser`: calamineã®ãƒ©ãƒƒãƒ‘ãƒ¼ã€ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ãƒ¬ãƒ™ãƒ«ã®æ“ä½œ
* `SheetParser`: ã‚·ãƒ¼ãƒˆå˜ä½ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è§£æ

**å‡ºåŠ›:**
* `RawCellData`: ç”Ÿã®ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå€¤ã€å‹ã€åº§æ¨™ã€æ›¸å¼IDï¼‰
* `MergedRegion`: ã‚»ãƒ«çµåˆç¯„å›²æƒ…å ±
* `SheetMetadata`: ã‚·ãƒ¼ãƒˆã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

#### **1.4. Grid Module (`grid.rs`)**
**è²¬å‹™:**
* ã‚¹ãƒ‘ãƒ¼ã‚¹ãªã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¨ å¯†ãªã‚°ãƒªãƒƒãƒ‰æ§‹é€ ã¸ã®å†æ§‹ç¯‰
* ã‚»ãƒ«çµåˆã®è«–ç†çš„å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒ•ã‚£ãƒ«ï¼‰
* Markdownãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆã®ãŸã‚ã®å‰å‡¦ç†

**ä¸»è¦ãªæ§‹é€ ä½“:**
* `LogicalGrid`: è«–ç†çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚°ãƒªãƒƒãƒ‰è¡¨ç¾
* `Cell`: æ›¸å¼é©ç”¨å¾Œã®è¡¨ç¤ºæ–‡å­—åˆ—ã‚’ä¿æŒã™ã‚‹ã‚»ãƒ«æ§‹é€ 

**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**
1. ãƒ‘ãƒ¼ã‚µãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸã‚¹ãƒ‘ãƒ¼ã‚¹ãªã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡Œåˆ—å½¢å¼ã«å±•é–‹
2. ã‚»ãƒ«çµåˆæƒ…å ±ã‚’è§£æã—ã€çµåˆæˆ¦ç•¥ã«åŸºã¥ã„ã¦å‡¦ç†
3. Formatterãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã‚°ãƒªãƒƒãƒ‰ã‚’åŸ‹ã‚ã‚‹

#### **1.5. Formatter Module (`formatter.rs`)**
**è²¬å‹™:**
* ç”Ÿã®ã‚»ãƒ«å€¤ï¼ˆf64ã€Stringã€Boolï¼‰ã‹ã‚‰è¡¨ç¤ºæ–‡å­—åˆ—ã¸ã®å¤‰æ›
* Number Format Stringã®è§£æã¨é©ç”¨
* æ—¥ä»˜ãƒ»æ™‚åˆ»ã®ã‚·ãƒªã‚¢ãƒ«å€¤å¤‰æ›

**ä¸»è¦ãªæ§‹é€ ä½“:**
* `CellFormatter`: ã‚»ãƒ«å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå‡¦ç†ã®ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰
* `DateFormatter`: æ—¥ä»˜å°‚ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
* `NumberFormatter`: æ•°å€¤å°‚ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼

**ä¾å­˜é–¢ä¿‚:**
* Number Format Parser Submoduleï¼ˆç‹¬ç«‹ã—ãŸã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰

#### **1.6. Number Format Parser Submodule (`format/mod.rs`)**
**è²¬å‹™:**
* Excel Number Format Stringã®æ§‹æ–‡è§£æ
* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ­£æ•°ã€è² æ•°ã€ã‚¼ãƒ­ã€ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã®åˆ†é›¢
* ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®æŠ½å‡ºã¨è§£é‡ˆ

**ä¸»è¦ãªæ§‹é€ ä½“:**
* `FormatParser`: ãƒ‘ãƒ¼ã‚µãƒ¼ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
* `FormatSection`: ã‚»ã‚¯ã‚·ãƒ§ãƒ³å˜ä½ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæƒ…å ±
* `FormatToken`: å€‹åˆ¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦ç´ ï¼ˆå¹´ã€æœˆã€æ—¥ã€å°æ•°ç‚¹ãªã©ï¼‰

**å‚™è€ƒ:**
* ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å°†æ¥çš„ã«ç‹¬ç«‹ã—ãŸã‚¯ãƒ¬ãƒ¼ãƒˆï¼ˆ`formato`ï¼‰ã¨ã—ã¦åˆ‡ã‚Šå‡ºã—å¯èƒ½ãªè¨­è¨ˆã¨ã™ã‚‹

#### **1.7. Types Module (`types.rs`)**
**è²¬å‹™:**
* ã‚¯ãƒ¬ãƒ¼ãƒˆå…¨ä½“ã§ä½¿ç”¨ã™ã‚‹å…±é€šã®ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©
* ã‚»ãƒ«å€¤ã®åˆ—æŒ™å‹ã€åº§æ¨™å‹ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ§‹é€ ä½“ãªã©

**ä¸»è¦ãªå‹:**
* `CellValue`: ã‚»ãƒ«ã®å€¤ã‚’è¡¨ã™åˆ—æŒ™å‹ï¼ˆNumber(f64), String(String), Bool(bool), Error(String), Emptyï¼‰
* `CellCoord`: ã‚»ãƒ«åº§æ¨™ (row: u32, col: u32)
* `CellRange`: ã‚»ãƒ«ç¯„å›² (start: CellCoord, end: CellCoord)

#### **1.8. Error Types Module (`error.rs`)**
**è²¬å‹™:**
* ã‚¯ãƒ¬ãƒ¼ãƒˆå…¨ä½“ã®ã‚¨ãƒ©ãƒ¼å‹å®šç¾©
* thiserrorã‚’ä½¿ç”¨ã—ãŸæ§‹é€ åŒ–ã‚¨ãƒ©ãƒ¼ã®å®Ÿè£…

**ä¸»è¦ãªå‹:**
* `XlsxToMdError`: å…¬é–‹ã‚¨ãƒ©ãƒ¼å‹ï¼ˆåˆ—æŒ™å‹ï¼‰
  * `Io(#[from] std::io::Error)`: I/Oã‚¨ãƒ©ãƒ¼
  * `Parse(#[from] calamine::Error)`: è§£æã‚¨ãƒ©ãƒ¼
  * `Config(String)`: è¨­å®šã‚¨ãƒ©ãƒ¼
  * `UnsupportedFeature(String)`: æœªã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼

---

## **2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®é–¢ä¿‚**

### **2.1. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚
â”‚   Code      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Create Builder
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConverterBuilderâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Configure & Build
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Converter     â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Config Data  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. convert(input, output)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WorkbookParser  â”‚<â”€â”€â”€â”€â”€â”€ calamine (external)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Stream RawCellData + Metadata
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CellFormatter   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Format Parserâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. Formatted Display String
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LogicalGrid    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Dense Grid Structure
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Markdown Writer â”‚â”€â”€â”€â”€â”€â”€â”€â”€> output (std::io::Write)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2.2. ä¸»è¦ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³**

#### **ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: "Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŸºæœ¬çš„ãªMarkdownãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›"**

```
User          Builder       Converter     Parser      Formatter    Grid         Output
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚ new()         â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚ with_sheet(0) â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚ build()       â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚ Converter    â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚ convert(in, out)             â”‚            â”‚            â”‚           â”‚            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ open_workbook(in)       â”‚           â”‚            â”‚
 â”‚               â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ for each cell           â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ RawCellDataâ”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ format_cell(raw, fmt_str)          â”‚            â”‚
 â”‚               â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚ DisplayString         â”‚            â”‚
 â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ add_cell(coord, display_str)       â”‚            â”‚
 â”‚               â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ (repeat for all cells)             â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ render_markdown()                  â”‚            â”‚
 â”‚               â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚ write(out)            â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚               â”‚              â”‚            â”‚            â”‚           â”‚            â”‚
 â”‚               â”‚              â”‚ Ok(())     â”‚            â”‚           â”‚            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚            â”‚           â”‚            â”‚
```

---

## **3. è¨­è¨ˆåŸå‰‡ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³**

### **3.1. æ¡ç”¨ã™ã‚‹ä¸»è¦ãªè¨­è¨ˆåŸå‰‡**

#### **3.1.1. SOLIDåŸå‰‡ã®é©ç”¨**

* **Single Responsibility Principle (å˜ä¸€è²¬ä»»ã®åŸå‰‡)**:
  * å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ˜ç¢ºã«å®šç¾©ã•ã‚ŒãŸå˜ä¸€ã®è²¬å‹™ã‚’æŒã¤ã€‚
  * ä¾‹: Parserãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯è§£æã®ã¿ã€Formatterãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ›¸å¼é©ç”¨ã®ã¿ã‚’æ‹…å½“ã€‚

* **Open/Closed Principle (é–‹æ”¾/é–‰é–ã®åŸå‰‡)**:
  * æ‹¡å¼µã«å¯¾ã—ã¦é–‹ã„ã¦ãŠã‚Šã€ä¿®æ­£ã«å¯¾ã—ã¦é–‰ã˜ã¦ã„ã‚‹è¨­è¨ˆã€‚
  * ä¾‹: ã‚»ãƒ«çµåˆæˆ¦ç•¥ã‚’`MergeStrategy` traitã¨ã—ã¦æŠ½è±¡åŒ–ã—ã€æ–°ã—ã„æˆ¦ç•¥ã‚’è¿½åŠ å¯èƒ½ã«ã™ã‚‹ã€‚

* **Dependency Inversion Principle (ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡)**:
  * ä¸Šä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä¸‹ä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…·è±¡ã«ä¾å­˜ã›ãšã€æŠ½è±¡ï¼ˆtraitï¼‰ã«ä¾å­˜ã™ã‚‹ã€‚
  * ä¾‹: Converterã¯Parserã®å…·è±¡å®Ÿè£…ã§ã¯ãªãã€`WorkbookReader` traitã«ä¾å­˜ã€‚

#### **3.1.2. é–¢å¿ƒã®åˆ†é›¢ (Separation of Concerns)**

* **è§£æãƒ­ã‚¸ãƒƒã‚¯ã¨å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢**:
  * Parserå±¤ï¼ˆcalamineä¾å­˜ï¼‰ã¨Formatterå±¤ï¼ˆæ›¸å¼å‡¦ç†ï¼‰ã‚’å®Œå…¨ã«åˆ†é›¢ã€‚
  * Parserã®å¤‰æ›´ãŒFormatterã«å½±éŸ¿ã‚’ä¸ãˆãªã„æ§‹é€ ã€‚

* **ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢**:
  * Types Moduleã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©ã—ã€å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã€‚

#### **3.1.3. ã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ– (Zero-Cost Abstraction)**

* ãƒˆãƒ¬ã‚¤ãƒˆãƒ™ãƒ¼ã‚¹ã®æŠ½è±¡åŒ–ã‚’ä½¿ç”¨ã—ã¤ã¤ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’æœ€å°åŒ–ã€‚
* é™çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’å„ªå…ˆã—ã€å‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã¯å¿…è¦ãªå ´åˆã®ã¿ä½¿ç”¨ã€‚

### **3.2. é©ç”¨ã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³**

#### **3.2.1. Builder Patternï¼ˆãƒ“ãƒ«ãƒ€ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰**

**é©ç”¨ç®‡æ‰€:** ConverterBuilder

**ç†ç”±:**
* è¤‡é›‘ãªè¨­å®šï¼ˆã‚·ãƒ¼ãƒˆé¸æŠã€ç¯„å›²æŒ‡å®šã€çµåˆæˆ¦ç•¥ãªã©ï¼‰ã‚’æ®µéšçš„ã«æ§‹ç¯‰ã€‚
* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®æä¾›ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹é¸æŠçš„ãªã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚
* è¨­å®šã®æ¤œè¨¼ã‚’build()æ™‚ç‚¹ã§ä¸€æ‹¬å®Ÿè¡Œã—ã€ä¸æ­£ãªè¨­å®šã‚’æ—©æœŸã«æ¤œå‡ºã€‚

**å®Ÿè£…ä¾‹:**
```rust
let converter = ConverterBuilder::new()
    .with_sheet_index(0)
    .with_merge_strategy(MergeStrategy::DataDuplication)
    .with_date_format(DateFormat::Iso8601)
    .build()?;
```

#### **3.2.2. Strategy Patternï¼ˆæˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰**

**é©ç”¨ç®‡æ‰€:** ã‚»ãƒ«çµåˆå‡¦ç†

**ç†ç”±:**
* è¤‡æ•°ã®ã‚»ãƒ«çµåˆæˆ¦ç•¥ï¼ˆãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒ•ã‚£ãƒ«ã€HTMLãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ã™ã‚‹ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦ä»¶ã«å¿œã˜ã¦ã€é©åˆ‡ãªæˆ¦ç•¥ã‚’é¸æŠå¯èƒ½ã€‚

**å®Ÿè£…æ–¹é‡:**
* **Phase I**: åˆ—æŒ™å‹ã«ã‚ˆã‚‹å®Ÿè£…ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã§å®Ÿç”¨çš„ï¼‰
* **Phase IIä»¥é™**: å¿…è¦ã«å¿œã˜ã¦traitåŒ–ï¼ˆæ‹¡å¼µæ€§å‘ä¸Šï¼‰

**å®Ÿè£…ä¾‹ï¼ˆPhase Iï¼‰:**
```rust
#[derive(Debug, Clone, Copy)]
pub enum MergeStrategy {
    DataDuplication,
    HtmlFallback,
}

impl MergeStrategy {
    pub(crate) fn apply(&self, grid: &mut LogicalGrid, merge_regions: &[MergedRegion]) {
        match self {
            MergeStrategy::DataDuplication => apply_data_duplication(grid, merge_regions),
            MergeStrategy::HtmlFallback => apply_html_fallback(grid, merge_regions),
        }
    }
}
```

**å°†æ¥ã®æ‹¡å¼µï¼ˆPhase IIä»¥é™ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:**
```rust
// traitåŒ–ã«ã‚ˆã‚‹æ‹¡å¼µæ€§å‘ä¸Š
trait MergeStrategy {
    fn apply(&self, grid: &mut LogicalGrid, merge_regions: &[MergedRegion]);
}

struct DataDuplicationStrategy;
struct HtmlFallbackStrategy;

impl MergeStrategy for DataDuplicationStrategy { /* ... */ }
impl MergeStrategy for HtmlFallbackStrategy { /* ... */ }
```

#### **3.2.3. Facade Patternï¼ˆãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰**

**é©ç”¨ç®‡æ‰€:** Converter Module

**ç†ç”±:**
* Parserã€Formatterã€Gridã®è¤‡é›‘ãªå”èª¿å‡¦ç†ã‚’éš è”½ã—ã€ã‚·ãƒ³ãƒ—ãƒ«ãª`convert()`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ã‚’å…¬é–‹ã€‚
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å†…éƒ¨å®Ÿè£…ã®è©³ç´°ã‚’æ„è­˜ã›ãšã«å¤‰æ›å‡¦ç†ã‚’å®Ÿè¡Œå¯èƒ½ã€‚

#### **3.2.4. Streaming Patternï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰**

**é©ç”¨ç®‡æ‰€:** Parser Module

**ç†ç”±:**
* å¤§è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªã«å…¨å±•é–‹ã›ãšã€ã‚»ãƒ«å˜ä½ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã€‚
* ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®10%ä»¥ä¸‹ã«æŠ‘åˆ¶ã™ã‚‹è¦ä»¶ã‚’æº€ãŸã™ã€‚

**å®Ÿè£…æ¦‚è¦:**
* calamineã®`Range::rows()`ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã€è¡Œå˜ä½ã§å‡¦ç†ã€‚
* å„ã‚»ãƒ«ã‚’å‡¦ç†å¾Œã€å³åº§ã«Formatterã«æ¸¡ã—ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’Gridã«è¿½åŠ ã€‚

---

## **4. æŠ€è¡“é¸å®š**

### **4.1. å¤–éƒ¨ä¾å­˜ã‚¯ãƒ¬ãƒ¼ãƒˆ**

| ã‚¯ãƒ¬ãƒ¼ãƒˆ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | é¸å®šç†ç”± | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ |
|:---------|:-----------|:---------|:-----------|
| **calamine** | `^0.26` | Pure-Rustè£½ã®Excelãƒ‘ãƒ¼ã‚µãƒ¼ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è§£æå¯¾å¿œã€é«˜æ€§èƒ½ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ´»ç™ºã€‚ | MIT/Apache-2.0 |
| **thiserror** | `^1.0` | æ§‹é€ åŒ–ã‚¨ãƒ©ãƒ¼ã®å®šç¾©ã‚’ç°¡æ½”ã«è¨˜è¿°å¯èƒ½ã€‚`#[from]`å±æ€§ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼å¤‰æ›ã®è‡ªå‹•åŒ–ã€‚ | MIT/Apache-2.0 |
| **chrono** | `^0.4` | æ—¥ä»˜ãƒ»æ™‚åˆ»å‡¦ç†ã®æ¨™æº–ã‚¯ãƒ¬ãƒ¼ãƒˆã€‚NaiveDateTimeå‹ã‚’ä½¿ç”¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³éä¾å­˜ï¼‰ã€‚ | MIT/Apache-2.0 |

### **4.2. å†…éƒ¨å®Ÿè£…æ–¹é‡**

#### **4.2.1. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®å®Ÿç¾**

**é¸æŠ:** calamineã®`Range::rows()`ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ + BufWriter

**ç†ç”±:**
* DOMæ–¹å¼ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«å±•é–‹ï¼‰ã‚’é¿ã‘ã€SAXãƒ©ã‚¤ã‚¯ãªã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹å‡¦ç†ã‚’å®Ÿç¾ã€‚
* å„è¡Œã‚’å‡¦ç†å¾Œã€å³åº§ã«å‡ºåŠ›ãƒãƒƒãƒ•ã‚¡ã«æ›¸ãè¾¼ã‚€ã“ã¨ã§ã€ãƒ¡ãƒ¢ãƒªãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆã‚’æœ€å°åŒ–ã€‚

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³:**
```rust
use std::io::{BufWriter, Write};

fn convert_sheet<W: Write>(range: Range<DataType>, output: W) -> Result<()> {
    let mut writer = BufWriter::new(output);

    for row in range.rows() {
        for cell in row {
            // ã‚»ãƒ«å‡¦ç†
            let formatted = format_cell(cell)?;
            write!(writer, "{}\t", formatted)?;
        }
        writeln!(writer)?;
    }

    writer.flush()?;
    Ok(())
}
```

#### **4.2.2. Number Format Stringã®è§£æ**

**é¸æŠ:** ç‹¬è‡ªå®Ÿè£…ï¼ˆå°†æ¥çš„ã«formatoã‚¯ãƒ¬ãƒ¼ãƒˆã¸ã®åˆ‡ã‚Šå‡ºã—ã‚’æ¤œè¨ï¼‰

**ç†ç”±:**
* æ—¢å­˜ã®formatoã‚¯ãƒ¬ãƒ¼ãƒˆï¼ˆcrates.ioï¼‰ã¯æ›´æ–°ãŒåœæ»ã—ã¦ãŠã‚Šã€æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã‚’æº€ãŸã•ãªã„ã€‚
* Number Format Stringã®ä»•æ§˜ã¯è¤‡é›‘ã§ã€ç‹¬è‡ªå®Ÿè£…ã«ã‚ˆã‚Šæ­£ç¢ºãªå¤‰æ›ã‚’ä¿è¨¼ã€‚
* ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’å®¹æ˜“åŒ–ã€‚

**å®Ÿè£…ç¯„å›²:**
* æ—¥ä»˜ãƒ»æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ`yyyy-mm-dd`, `hh:mm:ss`ãªã©ï¼‰
* æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ`#,##0.00`, `0.00%`ãªã©ï¼‰
* æ¡ä»¶ä»˜ãæ›¸å¼ã®åŸºæœ¬çš„ãªã‚µãƒãƒ¼ãƒˆï¼ˆ`[Red]`, `[>100]`ãªã©ï¼‰

#### **4.2.3. ã‚»ãƒ«çµåˆã®å‡¦ç†**

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæˆ¦ç•¥: ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒ•ã‚£ãƒ«**

**å®Ÿè£…æ–¹é‡:**
1. calamineã‹ã‚‰`merged_regions()`ã§ã‚»ãƒ«çµåˆç¯„å›²ã‚’å–å¾—ã€‚
2. çµåˆç¯„å›²å†…ã®è¦ªã‚»ãƒ«ï¼ˆå·¦ä¸Šã‚»ãƒ«ï¼‰ã®å€¤ã‚’å–å¾—ã€‚
3. LogicalGridä¸Šã§ã€çµåˆç¯„å›²å†…ã®ã™ã¹ã¦ã®è«–ç†ã‚»ãƒ«ã«è¦ªã‚»ãƒ«ã®å€¤ã‚’è¤‡è£½ã€‚
4. ç´”ç²‹ãªMarkdownãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦å‡ºåŠ›ã€‚

**ä»£æ›¿æˆ¦ç•¥: HTMLãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**

**å®Ÿè£…æ–¹é‡:**
1. çµåˆã‚»ãƒ«ã‚’æ¤œå‡ºã—ãŸå ´åˆã€ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦å‡ºåŠ›ã€‚
2. `rowspan`/`colspan`å±æ€§ã‚’ä½¿ç”¨ã—ã¦ã€æ§‹é€ çš„å¿ å®Ÿæ€§ã‚’ç¶­æŒã€‚

---

## **5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥**

### **5.1. ãƒ¡ãƒ¢ãƒªåŠ¹ç‡**

* **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†:** å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«å±•é–‹ã›ãšã€è¡Œå˜ä½ã§å‡¦ç†ã€‚
* **BufWriterã®ä½¿ç”¨:** å‡ºåŠ›ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«æ•°ã‚’å‰Šæ¸›ã€‚
* **Copy-on-Writeã®å›é¿:** å¯èƒ½ãªé™ã‚Šå‚ç…§ã‚’ä½¿ç”¨ã—ã€ä¸è¦ãªã‚¯ãƒ­ãƒ¼ãƒ³ã‚’é¿ã‘ã‚‹ã€‚

### **5.2. å‡¦ç†é€Ÿåº¦**

* **ä¸¦åˆ—å‡¦ç†ã®æ¤œè¨:** å°†æ¥çš„ã«Rayonã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã€è¤‡æ•°ã‚·ãƒ¼ãƒˆã®ä¸¦åˆ—å‡¦ç†ã‚’å®Ÿè£…å¯èƒ½ã€‚
* **ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ€å°åŒ–:** `String::with_capacity()`ã§äº‹å‰ã«ãƒ¡ãƒ¢ãƒªã‚’ç¢ºä¿ã—ã€å†ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šæ¸›ã€‚

---

## **6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥**

### **6.1. ã‚¨ãƒ©ãƒ¼ä¼æ’­ã®æ–¹é‡**

* ã™ã¹ã¦ã®å…¬é–‹APIã¯`Result<T, XlsxToMdError>`ã‚’è¿”ã™ã€‚
* å†…éƒ¨å®Ÿè£…ã§ã®panic!ã¯ç¦æ­¢ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®ã¿è¨±å¯ï¼‰ã€‚
* `?`æ¼”ç®—å­ã«ã‚ˆã‚‹è‡ªå‹•ã‚¨ãƒ©ãƒ¼å¤‰æ›ã‚’æ´»ç”¨ã€‚

### **6.2. ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æä¾›**

* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€ã‚·ãƒ¼ãƒˆåã€ã‚»ãƒ«åº§æ¨™ãªã©ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å«ã‚ã‚‹ã€‚

**å®Ÿè£…ä¾‹:**
```rust
#[derive(Error, Debug)]
pub enum XlsxToMdError {
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),

    #[error("Failed to parse Excel file: {0}")]
    Parse(#[from] calamine::Error),

    #[error("Configuration error: {0}")]
    Config(String),

    #[error("Unsupported feature at sheet '{sheet}', cell {cell}: {message}")]
    UnsupportedFeature {
        sheet: String,
        cell: String,
        message: String,
    },
}
```

---

## **7. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥**

### **7.1. å˜ä½“ãƒ†ã‚¹ãƒˆ**

* å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å¯¾ã—ã¦ã€ç‹¬ç«‹ã—ãŸå˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã€‚
* Number Format Parserã¯ã€ç‰¹ã«åºƒç¯„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”¨æ„ï¼ˆExcelã®æ¨™æº–æ›¸å¼ã‚’ã™ã¹ã¦ã‚«ãƒãƒ¼ï¼‰ã€‚

### **7.2. çµ±åˆãƒ†ã‚¹ãƒˆ**

* `tests/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€å®Ÿéš›ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãŸçµ±åˆãƒ†ã‚¹ãƒˆã‚’é…ç½®ã€‚
* ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç¶²ç¾…:
  * å°è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ1MBæœªæº€ï¼‰
  * ä¸­è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ10MBã€œ100MBï¼‰
  * å¤§è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ1GBä»¥ä¸Šï¼‰
  * ã‚»ãƒ«çµåˆã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«
  * è¤‡é›‘ãªæ›¸å¼ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«

### **7.3. ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯**

* `benches/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€Criterionã‚’ä½¿ç”¨ã—ãŸãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’é…ç½®ã€‚
* ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ï¼ˆvalgrind, heaptrackï¼‰ã€‚

---

## **8. å°†æ¥ã®æ‹¡å¼µæ€§**

### **8.1. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

* å°†æ¥çš„ã«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚„ã‚«ã‚¹ã‚¿ãƒ çµåˆæˆ¦ç•¥ã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦è¿½åŠ å¯èƒ½ãªè¨­è¨ˆã‚’æ¤œè¨ã€‚

### **8.2. WebAssemblyå¯¾å¿œ**

* stdãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ä¾å­˜ã‚’æœ€å°é™ã«æŠ‘ãˆã€wasm32-unknown-unknownã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ã®å¯¾å¿œã‚’å®¹æ˜“åŒ–ã€‚

### **8.3. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ‹¡å¼µ**

* Markdownä»¥å¤–ã®å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆJSONã€CSVã€HTMLï¼‰ã‚’ã‚µãƒãƒ¼ãƒˆå¯èƒ½ãªè¨­è¨ˆã€‚
* å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’Strategy Patternã§æŠ½è±¡åŒ–ã€‚

---

## **ä»˜éŒ²: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ï¼‰**

```
xlsxzero/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs              // ã‚¯ãƒ¬ãƒ¼ãƒˆã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€å…¬é–‹APIã®å®šç¾©
â”‚   â”œâ”€â”€ builder.rs          // ConverterBuilderã®å®Ÿè£…
â”‚   â”œâ”€â”€ converter.rs        // Converterã®å®Ÿè£…ï¼ˆãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ï¼‰
â”‚   â”œâ”€â”€ parser.rs           // WorkbookParser, SheetParserã®å®Ÿè£…
â”‚   â”œâ”€â”€ formatter.rs        // CellFormatter, DateFormatter, NumberFormatterã®å®Ÿè£…
â”‚   â”œâ”€â”€ grid.rs             // LogicalGrid, Cellã®å®Ÿè£…
â”‚   â”œâ”€â”€ types.rs            // å…±é€šãƒ‡ãƒ¼ã‚¿å‹ã®å®šç¾©
â”‚   â”œâ”€â”€ error.rs            // XlsxToMdErrorã®å®šç¾©
â”‚   â””â”€â”€ format/             // Number Format Parser Submodule
â”‚       â”œâ”€â”€ mod.rs          // ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚       â”œâ”€â”€ parser.rs       // FormatParserã®å®Ÿè£…
â”‚       â”œâ”€â”€ tokens.rs       // FormatTokenã®å®šç¾©
â”‚       â””â”€â”€ sections.rs     // FormatSectionã®å®šç¾©
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ integration_test.rs // çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ fixtures/           // ãƒ†ã‚¹ãƒˆç”¨Excelãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ benches/
â”‚   â””â”€â”€ benchmark.rs        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
â””â”€â”€ examples/
    â””â”€â”€ basic_conversion.rs // åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹
```

---

## **9. Phase IIæ‹¡å¼µ: XML Metadata Parserãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**

### **9.1. æ¦‚è¦**

Phase Iã§ã¯ã€calamineã®APIã®ã¿ã‚’ä½¿ç”¨ã—ã¦åŸºæœ¬æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚Phase IIã§ã¯ã€calamineã§å–å¾—ã§ããªã„æƒ…å ±ï¼ˆNumber Format Stringã€éè¡¨ç¤ºæƒ…å ±ï¼‰ã‚’è£œå®Œã™ã‚‹ãŸã‚ã€**XML Metadata Parserãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**ã‚’è¿½åŠ å®Ÿè£…ã™ã‚‹ã€‚

**èƒŒæ™¯ï¼ˆIssue #2èª¿æŸ»çµæœï¼‰:**
- âœ… calamine 0.32.0ã¯æ•°å¼ãƒ»çµåˆã‚»ãƒ«æƒ…å ±ã®å–å¾—ã«å¯¾å¿œ
- âŒ Number Format Stringï¼ˆæ›¸å¼æ–‡å­—åˆ—ï¼‰ã®å–å¾—ã¯æœªå¯¾å¿œ
- âŒ éè¡¨ç¤ºè¡Œ/åˆ—ã®æƒ…å ±å–å¾—ã¯æœªå¯¾å¿œï¼ˆGitHub Issue #237ï¼‰

**å®Ÿè£…æ–¹é‡:**
- ä¾å­˜ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’å¢—ã‚„ã•ãšã€`quick-xml`ï¼ˆcalamineãŒæ—¢ã«ä¾å­˜ï¼‰ã¨`zip`ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
- XMLç›´æ¥è§£æã«ã‚ˆã‚Šã€ä¸è¶³æƒ…å ±ã‚’è£œå®Œ
- calamineã¨ã®å…±å­˜: calamineã§åŸºæœ¬ãƒ‡ãƒ¼ã‚¿å–å¾— + XmlMetadataParserã§è£œè¶³æƒ…å ±å–å¾—

### **9.2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã®æ‹¡å¼µ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          xlsxzero crate                              â”‚
â”‚                     (å…¬é–‹API / Facade Layer)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Builder     â”‚   â”‚  Converter   â”‚   â”‚   ErrorTypes    â”‚
â”‚   Module      â”‚   â”‚   Module     â”‚   â”‚    Module       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚
        â”‚                  â–¼
        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Parser       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Module       â”‚             â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                           â”‚                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
        â”‚                  â”‚             â”‚       â”‚
        â–¼                  â–¼             â–¼       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Formatter   â”‚   â”‚   Grid       â”‚   â”‚ XmlMetadataParser â”‚ [Phase II]
â”‚   Module     â”‚   â”‚  Module      â”‚   â”‚     Module        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Number Format Parser    â”‚
â”‚  Submodule               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **9.3. XmlMetadataParser Module (`parser/metadata.rs`)**

#### **è²¬å‹™:**
* XLSXå†…éƒ¨ã®XMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€calamineã§å–å¾—ä¸å¯èƒ½ãªæƒ…å ±ã‚’æŠ½å‡º
* Number Format Stringï¼ˆã‚«ã‚¹ã‚¿ãƒ æ›¸å¼ï¼‰ã®å–å¾—
* éè¡¨ç¤ºè¡Œ/åˆ—ã®æƒ…å ±å–å¾—
* 1904å¹´ã‚¨ãƒãƒƒã‚¯åˆ¤å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### **ä¸»è¦ãªæ§‹é€ ä½“:**

```rust
pub(crate) struct XlsxMetadataParser {
    // xl/styles.xml ã‹ã‚‰è§£æ
    num_formats: HashMap<u32, String>,   // numFmtId -> formatCode
    cell_xfs: Vec<CellXf>,               // styleId -> (numFmtId, fontId, ...)

    // xl/worksheets/sheet*.xml ã‹ã‚‰è§£æ
    hidden_rows: HashMap<String, HashSet<u32>>,  // sheet_name -> row_indices
    hidden_cols: HashMap<String, HashSet<u32>>,  // sheet_name -> col_indices

    // xl/workbook.xml ã‹ã‚‰è§£æï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    is_1904: bool,  // date1904å±æ€§
}

#[derive(Debug, Clone)]
pub(crate) struct CellXf {
    pub num_fmt_id: u32,
    pub font_id: Option<u32>,
    pub fill_id: Option<u32>,
    pub border_id: Option<u32>,
}
```

#### **ä¸»è¦ãªãƒ¡ã‚½ãƒƒãƒ‰:**

```rust
impl XlsxMetadataParser {
    /// XLSXãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆZIPã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
    pub fn new<R: Read + Seek>(xlsx_reader: R) -> Result<Self, XlsxToMdError> {
        let mut archive = zip::ZipArchive::new(xlsx_reader)?;

        // 1. xl/styles.xml ã‚’è§£æ
        let (num_formats, cell_xfs) = Self::parse_styles(&mut archive)?;

        // 2. xl/worksheets/*.xml ã‚’è§£æ
        let (hidden_rows, hidden_cols) = Self::parse_worksheets(&mut archive)?;

        // 3. xl/workbook.xml ã‚’è§£æï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        let is_1904 = Self::parse_workbook(&mut archive)?;

        Ok(Self { num_formats, cell_xfs, hidden_rows, hidden_cols, is_1904 })
    }

    /// styleIdã‹ã‚‰Number Format Stringã‚’å–å¾—
    pub fn get_format_string(&self, style_id: u32) -> Option<&str> {
        self.cell_xfs.get(style_id as usize)
            .and_then(|xf| self.num_formats.get(&xf.num_fmt_id))
            .map(|s| s.as_str())
    }

    /// è¡ŒãŒéè¡¨ç¤ºã‹ã©ã†ã‹ã‚’åˆ¤å®š
    pub fn is_row_hidden(&self, sheet_name: &str, row: u32) -> bool {
        self.hidden_rows.get(sheet_name)
            .map(|rows| rows.contains(&row))
            .unwrap_or(false)
    }

    /// åˆ—ãŒéè¡¨ç¤ºã‹ã©ã†ã‹ã‚’åˆ¤å®š
    pub fn is_col_hidden(&self, sheet_name: &str, col: u32) -> bool {
        self.hidden_cols.get(sheet_name)
            .map(|cols| cols.contains(&col))
            .unwrap_or(false)
    }

    /// xl/styles.xml ã®è§£æï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼‰
    fn parse_styles<R: Read + Seek>(
        archive: &mut ZipArchive<R>
    ) -> Result<(HashMap<u32, String>, Vec<CellXf>), XlsxToMdError> {
        // quick-xmlã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è§£æ
        // <numFmts><numFmt numFmtId="165" formatCode="0.000"/></numFmts>
        // <cellXfs><xf numFmtId="165" fontId="0"/></cellXfs>
    }

    /// xl/worksheets/*.xml ã®è§£æï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼‰
    fn parse_worksheets<R: Read + Seek>(
        archive: &mut ZipArchive<R>
    ) -> Result<(HashMap<String, HashSet<u32>>, HashMap<String, HashSet<u32>>), XlsxToMdError> {
        // <row r="15" hidden="1">...</row>
        // <cols><col min="3" max="3" hidden="1"/></cols>
    }

    /// xl/workbook.xml ã®è§£æï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼‰
    fn parse_workbook<R: Read + Seek>(
        archive: &mut ZipArchive<R>
    ) -> Result<bool, XlsxToMdError> {
        // <workbookPr date1904="true"/>
    }
}
```

### **9.4. WorkbookParserã¨ã®çµ±åˆ**

Phase IIã§ã¯ã€`WorkbookParser`ãŒcalamineã¨XmlMetadataParserã®ä¸¡æ–¹ã‚’ä¿æŒã™ã‚‹:

```rust
pub(crate) struct WorkbookParser<R: Read + Seek> {
    workbook: Xlsx<R>,                          // Phase I
    metadata: Option<XlsxMetadataParser>,       // Phase II
}

impl<R: Read + Seek> WorkbookParser<R> {
    /// Phase IIå¯¾å¿œã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
    pub fn open_with_metadata(reader: R) -> Result<Self, XlsxToMdError> {
        // 1å›ã®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã§ä¸¡æ–¹ã‚’åˆæœŸåŒ–
        let mut buffer = Vec::new();
        reader.read_to_end(&mut buffer)?;

        let workbook = open_workbook_from_bytes(&buffer)?;
        let metadata = Some(XlsxMetadataParser::new(Cursor::new(&buffer))?);

        Ok(Self { workbook, metadata })
    }
}
```

### **9.5. è§£æå¯¾è±¡XMLã¨ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°**

#### **xl/styles.xml**

```xml
<styleSheet>
  <!-- ã‚«ã‚¹ã‚¿ãƒ æ›¸å¼å®šç¾© (numFmtId >= 164) -->
  <numFmts count="1">
    <numFmt numFmtId="165" formatCode="0.000"/>
  </numFmts>

  <!-- ã‚»ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© -->
  <cellXfs count="2">
    <xf numFmtId="0" fontId="0" fillId="0" borderId="0"/>
    <xf numFmtId="165" fontId="0" fillId="0" borderId="0"/>
  </cellXfs>
</styleSheet>
```

**ãƒãƒƒãƒ”ãƒ³ã‚°:**
- styleId=0 â†’ numFmtId=0 (ãƒ“ãƒ«ãƒˆã‚¤ãƒ³æ›¸å¼ "General")
- styleId=1 â†’ numFmtId=165 â†’ formatCode="0.000"

#### **xl/worksheets/sheet1.xml**

```xml
<worksheet>
  <!-- éè¡¨ç¤ºåˆ—å®šç¾© -->
  <cols>
    <col min="3" max="3" hidden="1" width="0" customWidth="1"/>
  </cols>

  <sheetData>
    <!-- éè¡¨ç¤ºè¡Œ -->
    <row r="15" hidden="1">
      <c r="A15"><v>Hidden Cell</v></c>
    </row>
  </sheetData>
</worksheet>
```

**åé›†ãƒ‡ãƒ¼ã‚¿:**
- hidden_cols: {3} (Cåˆ—ãŒéè¡¨ç¤º)
- hidden_rows: {15} (15è¡Œç›®ãŒéè¡¨ç¤º)

#### **xl/workbook.xml**

```xml
<workbook>
  <workbookPr date1904="true"/>
  <sheets>
    <sheet name="Sheet1" sheetId="1" r:id="rId1"/>
  </sheets>
</workbook>
```

**åé›†ãƒ‡ãƒ¼ã‚¿:**
- is_1904: true

### **9.6. ãƒ“ãƒ«ãƒˆã‚¤ãƒ³æ›¸å¼IDãƒãƒƒãƒ”ãƒ³ã‚°**

Excelã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³æ›¸å¼ï¼ˆnumFmtId 0-163ï¼‰ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã•ã‚Œãªã„ãŸã‚ã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå¿…è¦:

```rust
const BUILTIN_NUM_FORMATS: &[(u32, &str)] = &[
    (0, "General"),
    (1, "0"),
    (2, "0.00"),
    (3, "#,##0"),
    (4, "#,##0.00"),
    (9, "0%"),
    (10, "0.00%"),
    (14, "mm-dd-yy"),
    (15, "d-mmm-yy"),
    (16, "d-mmm"),
    (17, "mmm-yy"),
    (18, "h:mm AM/PM"),
    (19, "h:mm:ss AM/PM"),
    (20, "h:mm"),
    (21, "h:mm:ss"),
    (22, "m/d/yy h:mm"),
    // ... (å®Œå…¨ãªãƒªã‚¹ãƒˆã¯å®Ÿè£…æ™‚ã«è¿½åŠ )
];
```

### **9.7. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®æ›´æ–°**

```
xlsxzero/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs
â”‚   â”œâ”€â”€ builder.rs
â”‚   â”œâ”€â”€ converter.rs
â”‚   â”œâ”€â”€ parser.rs
â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ metadata.rs        // [Phase IIè¿½åŠ ] XmlMetadataParser
â”‚   â”œâ”€â”€ formatter.rs
â”‚   â”œâ”€â”€ grid.rs
â”‚   â”œâ”€â”€ types.rs
â”‚   â”œâ”€â”€ error.rs
â”‚   â””â”€â”€ format/
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ parser.rs
â”‚       â”œâ”€â”€ tokens.rs
â”‚       â””â”€â”€ sections.rs
```

### **9.8. å®Ÿè£…ã®æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**

**Phase I (calamine APIã®ã¿):**
- âœ… ã‚»ãƒ«å€¤ã®å–å¾—
- âœ… æ•°å¼æƒ…å ±ã®å–å¾—
- âœ… çµåˆã‚»ãƒ«æƒ…å ±ã®å–å¾—
- âš ï¸ æ›¸å¼æƒ…å ±: å‹ã‹ã‚‰ã®æ¨æ¸¬ã®ã¿
- âš ï¸ éè¡¨ç¤ºæƒ…å ±: ç„¡è¦–ï¼ˆå…¨ã‚»ãƒ«å‡¦ç†ï¼‰

**Phase II (XMLç›´æ¥è§£æè¿½åŠ ):**
- ğŸ”§ Number Format Stringã®å®Œå…¨å–å¾—
- ğŸ”§ éè¡¨ç¤ºè¡Œ/åˆ—ã®åˆ¤å®š
- ğŸ”§ 1904å¹´ã‚¨ãƒãƒƒã‚¯åˆ¤å®š

**Phase III (æœ€é©åŒ–ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³):**
- ğŸ”§ 1å›ã®ZIPèª­ã¿è¾¼ã¿ã§ä¸¡æ–¹ã‚’å‡¦ç†
- ğŸ”§ ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã®å‘ä¸Š

---

**æ–‡æ›¸ç®¡ç†æƒ…å ±:**
* ä½œæˆæ—¥: 2025-11-20
* æœ€çµ‚æ›´æ–°æ—¥: 2025-11-21
* ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.1 (Phase IIæ‹¡å¼µè¨­è¨ˆã‚’è¿½åŠ )
* é–¢é€£æ–‡æ›¸: [requirements.md](requirements.md), [consistency_check.md](consistency_check.md), [issue_list.md](issue_list.md)
